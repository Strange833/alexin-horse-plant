{% extends 'main/base.html' %}
{% load static %}

{% block title %}–ò–ò-–ß–∞—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç | –ê–ª–µ–∫—Å–∏–Ω—Å–∫–∏–π –∫–æ–Ω–Ω—ã–π –∑–∞–≤–æ–¥{% endblock %}

{% block extra_css %}
<style>
    .ai-chat-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .chat-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(45, 80, 22, 0.1), rgba(74, 124, 42, 0.1));
        border-radius: 15px;
        border: 2px solid #2d5016;
    }

    .chat-header h1 {
        color: #2d5016;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .chat-header p {
        color: #555;
        font-size: 1.1rem;
    }

    .chat-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        height: calc(100vh - 300px);
    }

    @media (max-width: 1024px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
    }

    .sidebar {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .chat-window {
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f9f9f9;
        min-height: 300px;
    }

    .chat-input-area {
        padding: 1rem;
        border-top: 2px solid #eee;
        background: white;
        display: flex;
        gap: 0.5rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π */
    .history-controls {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #eee;
        display: flex;
        gap: 0.5rem;
    }

    .btn-history {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .btn-danger {
        background: linear-gradient(45deg, #f44336, #e53935);
        color: white;
    }

    .btn-danger:hover {
        background: linear-gradient(45deg, #d32f2f, #c62828);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
    }

    .btn-warning {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        color: white;
    }

    .btn-warning:hover {
        background: linear-gradient(45deg, #f57c00, #ef6c00);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(255, 152, 0, 0.3);
    }

    .session-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .session-item {
        position: relative;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: #f5f5f5;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        border-left: 4px solid #4a7c2a;
        padding-right: 2.5rem; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
    }

    .session-item:hover {
        background: #e8f5e8;
        transform: translateX(5px);
    }

    .session-item.active {
        background: #d4edda;
        border-left-color: #155724;
    }

    .session-title {
        font-weight: 600;
        color: #2d5016;
        margin-bottom: 0.3rem;
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .session-date {
        font-size: 0.75rem;
        color: #666;
    }

    .delete-session-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #f44336;
        cursor: pointer;
        padding: 0.3rem;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
    }

    .session-item:hover .delete-session-btn {
        opacity: 1;
    }

    .delete-session-btn:hover {
        background: rgba(244, 67, 54, 0.1);
    }

    .confirm-delete-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .confirm-delete-modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-content h3 {
        color: #f44336;
        margin-bottom: 1rem;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: flex-end;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #2d5016;
        font-weight: 600;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #4a7c2a;
    }

    .btn {
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        color: white;
        width: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 12px;
        max-width: 80%;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .message.assistant {
        background: white;
        border: 2px solid #e0e0e0;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }

    .message.system {
        background: rgba(255, 152, 0, 0.1);
        border: 2px solid #ff9800;
        color: #666;
        text-align: center;
        max-width: 100%;
        margin: 1rem auto;
    }

    .message-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .message-content {
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.5rem;
        text-align: right;
    }

    .chat-input {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        resize: none;
        height: 60px;
    }

    .chat-input:focus {
        outline: none;
        border-color: #4a7c2a;
    }

    .btn-send {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        color: white;
        border: none;
        padding: 0 2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-send:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        display: none;
        padding: 1rem;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        margin-bottom: 1rem;
        max-width: 100px;
    }

    .typing-indicator.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    .typing-dots {
        display: flex;
        gap: 0.3rem;
    }

    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    .recommendations-panel {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .product-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 1rem;
        transition: all 0.3s;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border-color: #4caf50;
    }

    .product-card h4 {
        color: #2d5016;
        margin-bottom: 0.5rem;
    }

    .product-price {
        color: #4caf50;
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ddd;
    }

    .ai-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .feature-card {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        border-top: 4px solid #4a7c2a;
    }

    .feature-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞ */
    .chat-controls {
        padding: 0.5rem 1rem;
        border-bottom: 2px solid #eee;
        background: white;
        display: flex;
        gap: 0.5rem;
    }

    .btn-clear-chat {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        transition: all 0.3s;
    }

    .btn-clear-chat:hover {
        background: linear-gradient(45deg, #f57c00, #ef6c00);
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(255, 152, 0, 0.3);
    }

    .chat-messages.empty:after {
        content: "üí¨ –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∑–¥–µ—Å—å";
        display: block;
        text-align: center;
        color: #999;
        padding: 3rem;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <div class="chat-header">
        <h1>ü§ñ –ò–ò-–ß–∞—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h1>
        <p>–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ—Ä–º–ª–µ–Ω–∏—é –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>
    </div>

    <div class="chat-layout">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="sidebar">
            <div class="history-controls">
                <button class="btn-history btn-danger" onclick="showDeleteAllModal()">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë
                </button>
                <button class="btn-history btn-warning" onclick="showDeleteOldModal()">
                    üìÖ –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ
                </button>
            </div>

            <div class="session-list">
                <h3>üìÅ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</h3>
                {% if sessions %}
                    {% for session in sessions %}
                    <div class="session-item" data-session-id="{{ session.id }}">
                        <div class="session-title">{{ session.title }}</div>
                        <div class="session-date">{{ session.created_at|date:"d.m.Y H:i" }}</div>
                        <button class="delete-session-btn" onclick="deleteSession('{{ session.id }}', this)">
                            √ó
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div>üìù</div>
                        <p>–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</p>
                    </div>
                {% endif %}
            </div>

            <h3>üìã –ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</h3>
            <form id="horseForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="breed">–ü–æ—Ä–æ–¥–∞</label>
                    <select id="breed" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä–æ–¥—É</option>
                        {% for value, label in breed_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="age">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç)</label>
                    <input type="number" id="age" min="0" max="40" required>
                </div>

                <div class="form-group">
                    <label for="weight">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="weight" min="100" max="1000" required>
                </div>

                <div class="form-group">
                    <label for="purpose">–¶–µ–ª—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è</label>
                    <select id="purpose" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å</option>
                        {% for value, label in purpose_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="budget">–ë—é–¥–∂–µ—Ç (‚ÇΩ/–º–µ—Å—è—Ü)</label>
                    <input type="number" id="budget" min="1000" max="100000" required>
                </div>

                <div class="form-group">
                    <label for="activity_level">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
                    <select id="activity_level">
                        <option value="low">–ù–∏–∑–∫–∞—è</option>
                        <option value="medium" selected>–°—Ä–µ–¥–Ω—è—è</option>
                        <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    üöÄ –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                </button>
            </form>

            <div class="ai-features">
                <div class="feature-card">
                    <div class="feature-icon">üóëÔ∏è</div>
                    <p>–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <p>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üíæ</div>
                    <p>–í—ã–±–æ—Ä–æ—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</p>
                </div>
            </div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div class="chat-window">
            <div class="chat-controls">
                <button class="btn-clear-chat" onclick="clearCurrentChat()">
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-content">
                        üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∫–æ—Ä–º–∞–º –¥–ª—è –ª–æ—à–∞–¥–µ–π. 
                        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞, –∏ —è –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω –¥–ª—è –≤–∞—à–µ–π –ª–æ—à–∞–¥–∏.
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <div class="chat-input-area">
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –∫–æ—Ä–º–∞—Ö..."
                    rows="2"
                ></textarea>
                <button class="btn-send" id="sendBtn">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã -->
    <div class="recommendations-panel" id="recommendationsPanel" style="display: none;">
        <h3>üõí –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h3>
        <div class="products-grid" id="productsGrid"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div class="confirm-delete-modal" id="deleteModal">
    <div class="modal-content">
        <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <p id="modalMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?</p>
        <div class="modal-buttons">
            <button class="btn-history btn-warning" onclick="hideDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-history btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let currentSessionId = null;
    let currentRecommendationId = null;
    let deleteAction = null; // –¢–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    let deleteSessionId = null; // ID —Å–µ—Å—Å–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const submitBtn = document.getElementById('submitBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const recommendationsPanel = document.getElementById('recommendationsPanel');
    const productsGrid = document.getElementById('productsGrid');
    const deleteModal = document.getElementById('deleteModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
    document.querySelectorAll('.session-item').forEach(item => {
        item.addEventListener('click', function() {
            if (!event.target.classList.contains('delete-session-btn')) {
                const sessionId = this.dataset.sessionId;
                loadChatSession(sessionId);
            }
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('horseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const horseData = {
            breed: document.getElementById('breed').value,
            age: document.getElementById('age').value,
            weight: document.getElementById('weight').value,
            purpose: document.getElementById('purpose').value,
            budget: document.getElementById('budget').value,
            activity_level: document.getElementById('activity_level').value
        };

        addMessage('user', `–ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: –ø–æ—Ä–æ–¥–∞ ${horseData.breed}, –≤–æ–∑—Ä–∞—Å—Ç ${horseData.age} –ª–µ—Ç, –≤–µ—Å ${horseData.weight} –∫–≥`);
        
        await getAIRecommendation(horseData);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendBtn.addEventListener('click', sendUserMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendUserMessage();
        }
    });

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π
    function showDeleteAllModal() {
        modalTitle.textContent = '–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é';
        modalMessage.textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        deleteAction = 'delete_all';
        deleteModal.classList.add('active');
    }

    function showDeleteOldModal() {
        modalTitle.textContent = '–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏';
        modalMessage.textContent = '–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π? –≠—Ç–æ –æ—á–∏—Å—Ç–∏—Ç –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç —Å–≤–µ–∂–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.';
        deleteAction = 'delete_old';
        deleteModal.classList.add('active');
    }

    function hideDeleteModal() {
        deleteModal.classList.remove('active');
        deleteAction = null;
        deleteSessionId = null;
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    confirmDeleteBtn.addEventListener('click', async function() {
        if (deleteAction === 'delete_all') {
            await deleteAllSessions();
        } else if (deleteAction === 'delete_old') {
            await deleteOldSessions();
        } else if (deleteAction === 'delete_session' && deleteSessionId) {
            await deleteSingleSession(deleteSessionId);
        }
        hideDeleteModal();
    });

    async function deleteAllSessions() {
        try {
            const response = await fetch('/food/api/delete-all-sessions/', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (data.success) {
                // –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
                document.querySelector('.session-list').innerHTML = `
                    <div class="empty-state">
                        <div>üóëÔ∏è</div>
                        <p>–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</p>
                    </div>
                `;
                
                // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                clearChatMessages();
                currentSessionId = null;
                
                showNotification('‚úÖ –í—Å—è –∏—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
            }
        } catch (error) {
            console.error('Error deleting all sessions:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        }
    }

    async function deleteOldSessions() {
        try {
            const response = await fetch('/food/api/delete-old-sessions/', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (data.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
                reloadSessionList();
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                if (data.deleted_sessions && data.deleted_sessions.includes(currentSessionId)) {
                    clearChatMessages();
                    currentSessionId = null;
                }
                
                showNotification(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${data.deleted_count} —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π`, 'success');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π', 'error');
            }
        } catch (error) {
            console.error('Error deleting old sessions:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        }
    }

    function deleteSession(sessionId, button) {
        event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–µ—Å—Å–∏–∏
        const sessionItem = button.closest('.session-item');
        const sessionTitle = sessionItem.querySelector('.session-title').textContent;
        
        modalTitle.textContent = '–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é';
        modalMessage.textContent = `–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é "${sessionTitle}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
        deleteAction = 'delete_session';
        deleteSessionId = sessionId;
        deleteModal.classList.add('active');
    }

    async function deleteSingleSession(sessionId) {
        try {
            const response = await fetch(`/food/api/delete-session/${sessionId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (data.success) {
                // –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
                const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (sessionItem) {
                    sessionItem.remove();
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è, –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                if (currentSessionId === sessionId) {
                    clearChatMessages();
                    currentSessionId = null;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø—É—Å—Ç –ª–∏ —Å–ø–∏—Å–æ–∫
                const sessionList = document.querySelector('.session-list');
                const sessionItems = sessionList.querySelectorAll('.session-item');
                if (sessionItems.length === 0) {
                    sessionList.innerHTML = `
                        <div class="empty-state">
                            <div>üìù</div>
                            <p>–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</p>
                        </div>
                    `;
                }
                
                showNotification('‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏', 'error');
            }
        } catch (error) {
            console.error('Error deleting session:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        }
    }

    async function reloadSessionList() {
        try {
            const response = await fetch('/food/api/sessions-list/', {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            
            if (data.success) {
                const sessionList = document.querySelector('.session-list');
                sessionList.innerHTML = '<h3>üìÅ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</h3>';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'session-item';
                        sessionDiv.dataset.sessionId = session.id;
                        sessionDiv.innerHTML = `
                            <div class="session-title">${session.title}</div>
                            <div class="session-date">${session.created_at}</div>
                            <button class="delete-session-btn" onclick="deleteSession('${session.id}', this)">
                                √ó
                            </button>
                        `;
                        
                        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        sessionDiv.addEventListener('click', function(e) {
                            if (!e.target.classList.contains('delete-session-btn')) {
                                loadChatSession(session.id);
                            }
                        });
                        
                        sessionList.appendChild(sessionDiv);
                    });
                } else {
                    sessionList.innerHTML = `
                        <div class="empty-state">
                            <div>üìù</div>
                            <p>–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</p>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error reloading session list:', error);
        }
    }

    function clearCurrentChat() {
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —á–∞—Ç (–Ω–µ —É–¥–∞–ª—è–µ–º –∏–∑ –ë–î)
        clearChatMessages();
        currentSessionId = null;
        showNotification('üßπ –¢–µ–∫—É—â–∏–π —á–∞—Ç –æ—á–∏—â–µ–Ω', 'info');
    }

    function clearChatMessages() {
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        chatMessages.innerHTML = `
            <div class="message system">
                <div class="message-content">
                    üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∫–æ—Ä–º–∞–º –¥–ª—è –ª–æ—à–∞–¥–µ–π. 
                    –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞, –∏ —è –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω –¥–ª—è –≤–∞—à–µ–π –ª–æ—à–∞–¥–∏.
                </div>
            </div>
        `;
        
        // –ü—Ä—è—á–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        recommendationsPanel.style.display = 'none';
    }

    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'};
            color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'};
            border: 2px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#ffeaa7'};
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–π –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
    async function sendUserMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        if (!currentSessionId) {
            showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é', 'warning');
            return;
        }

        addMessage('user', message);
        chatInput.value = '';
        
        await getAIResponse(message);
    }

    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const header = document.createElement('div');
        header.className = 'message-header';
        header.innerHTML = role === 'user' ? 'üë§ –í—ã' : 'ü§ñ –ò–ò-–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function getAIRecommendation(horseData) {
        submitBtn.disabled = true;
        typingIndicator.classList.add('active');

        try {
            const response = await fetch('/food/api/ai-recommendation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(horseData)
            });

            const data = await response.json();
            
            if (data.success) {
                addMessage('assistant', data.response);
                currentSessionId = data.session_id;
                currentRecommendationId = data.recommendation_id;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
                await reloadSessionList();
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                if (data.recommended_products && data.recommended_products.length > 0) {
                    showRecommendedProducts(data.recommended_products);
                }
            } else {
                addMessage('assistant', `–û—à–∏–±–∫–∞: ${data.message}`);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('assistant', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        } finally {
            typingIndicator.classList.remove('active');
            submitBtn.disabled = false;
        }
    }

    async function getAIResponse(message) {
        sendBtn.disabled = true;
        typingIndicator.classList.add('active');

        try {
            const response = await fetch('/food/api/ai-chat-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    session_id: currentSessionId
                })
            });

            const data = await response.json();
            
            if (data.success) {
                addMessage('assistant', data.response);
            } else {
                addMessage('assistant', `–û—à–∏–±–∫–∞: ${data.message}`);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('assistant', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        } finally {
            typingIndicator.classList.remove('active');
            sendBtn.disabled = false;
        }
    }

    async function loadChatSession(sessionId) {
        try {
            const response = await fetch(`/food/api/ai-chat-session/${sessionId}/`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            
            if (data.success) {
                // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                chatMessages.innerHTML = '';
                
                // –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Å–µ—Å—Å–∏–∏
                data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
                
                currentSessionId = sessionId;
                
                // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–∞–π–¥–±–∞—Ä–µ
                document.querySelectorAll('.session-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        } catch (error) {
            console.error('Error loading session:', error);
        }
    }

    async function showRecommendedProducts(productIds) {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö
            const response = await fetch('/food/api/products/?ids=' + productIds.join(','));
            const products = await response.json();
            
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <h4>${product.name}</h4>
                    <p>${product.short_description || ''}</p>
                    <div class="product-price">${product.price} ‚ÇΩ</div>
                    <button class="btn btn-primary" onclick="addToCart('${product.id}')">
                        –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                `;
                productsGrid.appendChild(card);
            });

            recommendationsPanel.style.display = 'block';
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    async function addToCart(productId) {
        try {
            const response = await fetch('/cart/api/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            });

            const data = await response.json();
            
            if (data.success) {
                showNotification('üõí –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                document.getElementById('cartCount').textContent = data.cart_count;
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
        }
    }
</script>
{% endblock %}