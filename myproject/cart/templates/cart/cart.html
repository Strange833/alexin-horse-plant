{% extends 'main/base.html' %}
{% load static %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫ - –ê–ª–µ–∫—Å–∏–Ω—Å–∫–∏–π –∫–æ–Ω–Ω—ã–π –∑–∞–≤–æ–¥{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
<style>
    .empty-cart {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        margin: 2rem 0;
    }
    
    .empty-cart-icon {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        opacity: 0.7;
    }
    
    .empty-cart h2 {
        color: var(--dark-text);
        margin-bottom: 1rem;
        font-size: 1.8rem;
    }
    
    .empty-cart p {
        color: var(--light-text);
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .cart-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
        .empty-cart {
            padding: 3rem 1rem;
        }
        
        .cart-actions {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1><span class="cart-icon">üõí</span> –ö–æ—Ä–∑–∏–Ω–∞</h1>
            <p class="cart-subtitle">–¢–æ–≤–∞—Ä—ã –¥–ª—è –≤–∞—à–∏—Ö –ª–æ—à–∞–¥–µ–π</p>
        </div>
        
        {% if cart_items %}
        <!-- –ö–æ—Ä–∑–∏–Ω–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ -->
        <div class="cart-layout">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–≤–∞—Ä—ã -->
            <div class="cart-items-column">
                <div class="cart-section">
                    <h2 class="section-title">–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ</h2>
                    <div class="cart-items-list">
                        {% for item in cart_items %}
                        <div class="cart-item-card">
                            <div class="cart-item-image">
                                {% if item.food.image %}
                                <img src="{{ item.food.image.url }}" alt="{{ item.food.name }}">
                                {% else %}
                                <div class="item-image-placeholder">ü•ï</div>
                                {% endif %}
                            </div>
                            
                            <div class="cart-item-details">
                                <h3 class="item-name">{{ item.food.name }}</h3>
                                <p class="item-category">{{ item.food.category.name|default:"–ö–æ—Ä–º–∞" }}</p>
                                <p class="item-unit">{{ item.food.weight }} {{ item.food.get_unit_display }}</p>
                                
                                <div class="item-price-section">
                                    <span class="item-price">{{ item.price_at_addition }} ‚ÇΩ</span>
                                    <div class="item-quantity-controls">
                                        <button class="quantity-btn minus" 
                                                data-item-id="{{ item.id }}" 
                                                onclick="updateCartItemQuantity('{{ item.id }}', -1)">-</button>
                                        <span class="item-quantity">{{ item.quantity }}</span>
                                        <button class="quantity-btn plus" 
                                                data-item-id="{{ item.id }}" 
                                                onclick="updateCartItemQuantity('{{ item.id }}', 1)">+</button>
                                    </div>
                                    <span class="item-total">{{ item.total_price }} ‚ÇΩ</span>
                                </div>
                            </div>
                            
                            <button class="item-remove" onclick="removeFromCart('{{ item.id }}')">
                                ‚úï
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="continue-shopping">
                        <a href="{% url 'food_list' %}" class="btn-continue">
                            ‚Üê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ -->
            <div class="cart-summary-column">
                <div class="order-summary-card">
                    <h2 class="summary-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
                    
                    <!-- –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
                    <form id="checkoutForm" method="POST" action="{% url 'checkout' %}">
                        {% csrf_token %}
                        
                        <!-- –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                        <div class="form-section">
                            <h3><span>üë§</span> –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="customer_name">–§–ò–û *</label>
                                    <input type="text" id="customer_name" name="customer_name" 
                                           value="{{ user.get_full_name }}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="customer_phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                    <input type="tel" id="customer_phone" name="customer_phone" 
                                           value="{{ user.profile.phone|default:'' }}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="customer_email">Email</label>
                                    <input type="email" id="customer_email" name="customer_email" 
                                           value="{{ user.email }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-section">
                            <h3><span>üìç</span> –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="delivery_city">–ì–æ—Ä–æ–¥ *</label>
                                    <input type="text" id="delivery_city" name="delivery_city" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="delivery_street">–£–ª–∏—Ü–∞ *</label>
                                    <input type="text" id="delivery_street" name="delivery_street" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="delivery_house">–î–æ–º *</label>
                                    <input type="text" id="delivery_house" name="delivery_house" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="delivery_apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞/–û—Ñ–∏—Å</label>
                                    <input type="text" id="delivery_apartment" name="delivery_apartment">
                                </div>
                                
                                <div class="form-group">
                                    <label for="delivery_index">–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å</label>
                                    <input type="text" id="delivery_index" name="delivery_index">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-section">
                            <h3><span>üöö</span> –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                            <div class="delivery-options">
                                <label class="delivery-option">
                                    <input type="radio" name="delivery_method" value="courier" checked>
                                    <div class="delivery-content">
                                        <span class="delivery-icon">üöó</span>
                                        <div class="delivery-info">
                                            <strong>–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</strong>
                                            <small>1-3 –¥–Ω—è ‚Ä¢ <span id="deliveryCostCourier">500 ‚ÇΩ</span></small>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="delivery-option">
                                    <input type="radio" name="delivery_method" value="pickup">
                                    <div class="delivery-content">
                                        <span class="delivery-icon">üè™</span>
                                        <div class="delivery-info">
                                            <strong>–°–∞–º–æ–≤—ã–≤–æ–∑</strong>
                                            <small>–°–∫–ª–∞–¥ –∑–∞–≤–æ–¥–∞ ‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</small>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="delivery-option">
                                    <input type="radio" name="delivery_method" value="post">
                                    <div class="delivery-content">
                                        <span class="delivery-icon">üìÆ</span>
                                        <div class="delivery-info">
                                            <strong>–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏</strong>
                                            <small>5-14 –¥–Ω–µ–π ‚Ä¢ <span id="deliveryCostPost">300 ‚ÇΩ</span></small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
                        <div class="form-section">
                            <h3><span>üí≥</span> –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="card" checked>
                                    <div class="payment-content">
                                        <span class="payment-icon">üí≥</span>
                                        <strong>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</strong>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="sbp">
                                    <div class="payment-content">
                                        <span class="payment-icon">üì±</span>
                                        <strong>–°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)</strong>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="applepay">
                                    <div class="payment-content">
                                        <span class="payment-icon">üçé</span>
                                        <strong>Apple Pay</strong>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="googlepay">
                                    <div class="payment-content">
                                        <span class="payment-icon">ü§ñ</span>
                                        <strong>Google Pay</strong>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="cash">
                                    <div class="payment-content">
                                        <span class="payment-icon">üíµ</span>
                                        <strong>–ù–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</strong>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
                        <div class="form-section">
                            <h3><span>üéÅ</span> –ü—Ä–æ–º–æ–∫–æ–¥</h3>
                            <div class="promo-section">
                                <div class="promo-input-group">
                                    <input type="text" id="promo_code" name="promo_code" 
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥">
                                    <button type="button" class="btn-apply-promo" onclick="applyPromoCode()">
                                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                                <div id="promoMessage" class="promo-message"></div>
                            </div>
                        </div>
                        
                        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                        <div class="order-total-section">
                            <div class="total-row">
                                <span>–¢–æ–≤–∞—Ä—ã ({{ total_items }} —à—Ç.)</span>
                                <span id="subtotalAmount">{{ subtotal }} ‚ÇΩ</span>
                            </div>
                            
                            <div class="total-row">
                                <span>–°–±–æ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–∞</span>
                                <span id="assemblyCost">{{ assembly_cost }} ‚ÇΩ</span>
                            </div>
                            
                            <div class="total-row discount-row">
                                <span>–°–∫–∏–¥–∫–∞ <span id="discountPercent">{{ discount_percentage }}%</span></span>
                                <span class="discount-value" id="discountAmount">-{{ discount }} ‚ÇΩ</span>
                            </div>
                            
                            <div class="total-row">
                                <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                <span id="deliveryCost">{{ delivery_cost }} ‚ÇΩ</span>
                            </div>
                            
                            <div class="total-row final-total">
                                <strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</strong>
                                <strong id="totalAmount">{{ total_amount }} ‚ÇΩ</strong>
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                        <button type="submit" class="btn-checkout" id="checkoutBtn">
                            –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                        </button>
                        
                        <p class="terms-notice">
                            –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å 
                            <a href="#">—É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
        <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
            <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤–∞—à–∏—Ö –ª–æ—à–∞–¥–µ–π, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</p>
            
            <div class="cart-actions">
                <a href="{% url 'food_list' %}" class="btn-upgrade premium">
                    üõí –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
                </a>
                <a href="{% url 'index' %}" class="btn-continue">
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
<script>
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
    function updateCartItemQuantity(itemId, change) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/cart/api/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity_change: change
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    function removeFromCart(itemId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) return;
        
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/cart/api/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ item_id: itemId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–ø–æ—Å–æ–±–∞
    document.querySelectorAll('input[name="delivery_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateDeliveryCost();
        });
    });
    
    function updateDeliveryCost() {
        const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked').value;
        const deliveryCostElement = document.getElementById('deliveryCost');
        
        fetch('/cart/api/data/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let cost = 0;
                    if (deliveryMethod === 'pickup') {
                        cost = 0;
                    } else if (deliveryMethod === 'post') {
                        cost = 300;
                    } else {
                        cost = data.delivery_cost;
                    }
                    
                    deliveryCostElement.textContent = cost + ' ‚ÇΩ';
                    updateTotal();
                }
            });
    }
    
    function updateTotal() {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        fetch('/cart/api/data/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('subtotalAmount').textContent = data.subtotal + ' ‚ÇΩ';
                    document.getElementById('discountPercent').textContent = data.discount_percentage + '%';
                    document.getElementById('discountAmount').textContent = '- ' + data.discount + ' ‚ÇΩ';
                    document.getElementById('assemblyCost').textContent = data.assembly_cost + ' ‚ÇΩ';
                    document.getElementById('totalAmount').textContent = data.total + ' ‚ÇΩ';
                }
            });
    }
</script>
{% endblock %}